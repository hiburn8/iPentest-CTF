//
//  LabsViewController.m
//  iPentestCTF
//
//  Created by Daniel on 24/03/2015.
//  Copyright (c) 2015 Daniel Reece. All rights reserved.
//

#import "LabsViewController.h"
#import "LabsTableCell.h"

@interface LabsViewController ()

@end

@implementation LabsViewController
{
    NSArray *tableData;
    NSArray *thumbnails;
    NSArray *prepTime;
;
    
    NSArray *labname;
    NSArray *category;
    NSArray *difficulty;
    NSArray *desc;
    NSArray *url;
    NSArray *created;
    NSArray *author;
}
- (void)getLabs{
    
    
    NSString * element = @"labs";
    NSString *apiURL = [[NSString alloc] initWithFormat:@"http://hiburn8.org/ctf/api.php?%@", element];
    
    NSMutableURLRequest *request = [[NSMutableURLRequest alloc]
                                    initWithURL:[NSURL URLWithString:apiURL]];
    [request setHTTPMethod:@"GET"];
    
    
    //  [[NSURLConnection alloc] initWithRequest:request delegate:self];
    
    NSHTTPURLResponse *response = nil;
    NSError *error = nil;
    NSData *respData = [NSURLConnection sendSynchronousRequest:request returningResponse:&response error:&error];
    NSString *JSONDataStr = [[NSString alloc] initWithData:respData encoding:NSUTF8StringEncoding];
    
    NSData *jsonData = [JSONDataStr dataUsingEncoding:NSUTF8StringEncoding];
    
    NSArray *result = [NSJSONSerialization JSONObjectWithData:jsonData options:0 error:nil];
    
    labname = [result valueForKey:@"labname"];
    category = [result valueForKey:@"category"];
    difficulty = [result valueForKey:@"difficulty"];
    desc = [result valueForKey:@"labdescription"];
    url = [result valueForKey:@"url"];
    created = [result valueForKey:@"daysagocreated"];
    author = [result valueForKey:@"author"];
    
    /*
    NSLog(@"%@",labname);
    NSLog(@"%@",category);
    NSLog(@"%@",difficulty);
    NSLog(@"%@",desc);
    NSLog(@"%@",url);
    NSLog(@"%@",created);
    NSLog(@"%@",author);
    */
    
    //thumbnails = [NSArray arrayWithObjects:@"egg_benedict.jpg", @"mushroom_risotto.jpg", @"full_breakfast.jpg", @"", @"", @"", @"", @"ham_and_cheese_panini.jpg", nil];
    //prepTime = [NSArray arrayWithObjects:@"First", @"Second", @"Third", @"4", @"5", @"6", @"7", @"8", nil];
    
    // Find out the path of recipes.plist
    //NSString *path = [[NSBundle mainBundle] pathForResource:@"recipes" ofType:@"plist"];
    
    // Load the file content and read the data into arrays
    //    NSDictionary *dict = [[NSDictionary alloc] initWithContentsOfFile:path];
    //tableData = [dict objectForKey:@"RecipeName"];
    // thumbnails = [dict objectForKey:@"Thumbnail"];
    // prepTime = [dict objectForKey:@"PrepTime"];
}

- (NSArray *)getLabPwners:(NSString *)theLab{
    
    NSString *apiURL = [[NSString alloc] initWithFormat:@"http://hiburn8.org/ctf/api.php?allpwns"];
    
    NSMutableURLRequest *request = [[NSMutableURLRequest alloc]
                                    initWithURL:[NSURL URLWithString:apiURL]];
    [request setHTTPMethod:@"GET"];
    
    //  [[NSURLConnection alloc] initWithRequest:request delegate:self];
    NSHTTPURLResponse *response = nil;
    NSError *error = nil;
    NSData *respData = [NSURLConnection sendSynchronousRequest:request returningResponse:&response error:&error];
    NSString *JSONDataStr = [[NSString alloc] initWithData:respData encoding:NSUTF8StringEncoding];
    //NSDictionary *headerFields = [(NSHTTPURLResponse *)response allHeaderFields];
    
    NSData *jsonData = [JSONDataStr dataUsingEncoding:NSUTF8StringEncoding];
    
    NSArray *result = [NSJSONSerialization JSONObjectWithData:jsonData options:0 error:nil];
    
    NSMutableArray *allPwners = [NSMutableArray array];
    for (NSString *tempObject in result) {
        if ([[tempObject valueForKey:@"labname"] isEqual:theLab]){
            //NSLog(@"Single element: %@", [tempObject valueForKey:@"labname"]);
            
            NSString * aPwner = [tempObject valueForKey:@"username"];
            [allPwners addObject:aPwner];
            //NSLog(@"%@", allLabs);
        }
    }
    
    return allPwners;
}

- (void)viewDidLoad
{
    [super viewDidLoad];
    // Initialize table data
    [self getLabs];
}

- (void)viewDidUnload
{
    [super viewDidUnload];
    // Release any retained subviews of the main view.
}

- (BOOL)shouldAutorotateToInterfaceOrientation:(UIInterfaceOrientation)interfaceOrientation
{
    return (interfaceOrientation != UIInterfaceOrientationPortraitUpsideDown);
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    return [labname count];
}

- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath
{
    return 78;
}


- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    
    NSInteger rowIndex = indexPath.row;
    static NSString *simpleTableIdentifier = @"LabsTableCell";
    
    LabsTableCell *cell = (LabsTableCell *)[tableView dequeueReusableCellWithIdentifier:simpleTableIdentifier];
    if (cell == nil)
    {
        NSArray *nib = [[NSBundle mainBundle] loadNibNamed:@"LabsTableCell" owner:self options:nil];
        cell = [nib objectAtIndex:0];
    }
    

    
    cell.nameLabel.text = [labname objectAtIndex:rowIndex];
    cell.categoryLabel.text = [category objectAtIndex:rowIndex];
    cell.pointsLabel.text = [difficulty objectAtIndex:rowIndex];
    //cell.descLabel.text = [desc objectAtIndex:rowIndex];
    cell.authorLabel.text = [author objectAtIndex:rowIndex];
    
    //cell.thumbnailImageView.image = [UIImage imageNamed:[thumbnails objectAtIndex:indexPath.row]];
    if ([[category objectAtIndex:rowIndex]  isEqual: @"Mobile"]){
        cell.thumbnailImageView.image = [UIImage imageNamed:@"mobile.png"];
    }
    else if ([[category objectAtIndex:rowIndex]  isEqual: @"Programming"]){
        cell.thumbnailImageView.image = [UIImage imageNamed:@"programming.png"];
    }
    else if ([[category objectAtIndex:rowIndex]  isEqual: @"Web"]){
        cell.thumbnailImageView.image = [UIImage imageNamed:@"web.png"];
    }
    else if ([[category objectAtIndex:rowIndex]  isEqual: @"Forensics"]){
        cell.thumbnailImageView.image = [UIImage imageNamed:@"forensics.png"];
    }
    else if ([[category objectAtIndex:rowIndex]  isEqual: @"Reversing"]){
        cell.thumbnailImageView.image = [UIImage imageNamed:@"reversing.png"];
    }
    
    return cell;
}


- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
 
    NSArray * hisLabs = [self getLabPwners:([labname objectAtIndex:indexPath.row])];
    
   
    NSString *titleString = @"error";
    NSString * hisLabsString = @"";
    
    if (hisLabs != nil){
        hisLabsString = [hisLabs componentsJoinedByString:@"\n"];
        titleString = [NSString stringWithFormat:@"%@ completed by:",[labname objectAtIndex:indexPath.row]];
    }
    
    UIAlertView *messageAlert = [[UIAlertView alloc]
                                 initWithTitle:titleString message:hisLabsString delegate:nil cancelButtonTitle:@"OK" otherButtonTitles:nil];
    
    // Display the Hello World Message
    [messageAlert show];
    
    // Checked the selected row
    //UITableViewCell *cell = [tableView cellForRowAtIndexPath:indexPath];
    //cell.accessoryType = UITableViewCellAccessoryCheckmark;
    
    [tableView deselectRowAtIndexPath:indexPath animated:YES];
     
     
}


@end